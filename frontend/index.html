<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barbershop - Sistema de Reservas</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="notificacion" class="notificacion">
        <span class="cerrar-notificacion" onclick="cerrarNotificacion()">&times;</span>
        <div id="notificacion-titulo" style="font-weight:bold; margin-bottom:5px; color:#ffd700;"></div>
        <div id="notificacion-contenido" style="font-size:0.95em;"></div>
    </div>

    <div class="container">
        <h1>🪒 BARBERSHOP - SISTEMA DE RESERVAS</h1>
        
        <!-- TABS -->
        <div class="tabs">
            <div class="tab activo" onclick="cambiarTab('reservas')" id="tab-reservas">📅 RESERVAR CITA</div>
            <div class="tab" onclick="cambiarTab('admin')" id="tab-admin">👑 PANEL ADMIN</div>
        </div>

        <!-- SECCIÓN RESERVAS -->
        <div id="seccion-reservas">
            <h2>✨ Selecciona tu servicio ✨</h2>
            <div class="servicios-grid" id="servicios-container">
                <div style="text-align: center; grid-column: 1/-1;">Cargando servicios...</div>
            </div>

            <div class="formulario" id="formulario" style="display: none;">
                <h2>📋 Completa tus datos</h2>
                <div class="form-group">
                    <label>📅 Fecha</label>
                    <input type="date" id="fecha" onchange="cargarHorariosDisponibles()" required>
                </div>
                <div class="form-group">
                    <label>⏰ Hora</label>
                    <select id="hora" required>
                        <option value="">Selecciona una hora</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>👤 Nombre completo</label>
                    <input type="text" id="nombre" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="form-group">
                    <label>📱 Teléfono</label>
                    <input type="tel" id="telefono" placeholder="Ej: 3001234567" required>
                </div>
                <div class="form-group">
                    <label>✉️ Email</label>
                    <input type="email" id="email" placeholder="tucorreo@ejemplo.com" required>
                </div>
                <button id="btn-reservar" onclick="crearReserva()">RESERVAR CITA</button>
            </div>
        </div>

        <!-- SECCIÓN ADMIN -->
        <div id="seccion-admin" class="admin-panel oculto">
            <div class="admin-header">
                <h2 style="color:#ffd700; margin:0;">📊 PANEL DE ADMINISTRACIÓN</h2>
                <div class="filtros">
                    <select id="filtro-estado" onchange="cargarCitasAdmin()">
                        <option value="todas">Todas las citas</option>
                        <option value="pendiente">Pendientes</option>
                        <option value="confirmada">Confirmadas</option>
                        <option value="cancelada">Canceladas</option>
                    </select>
                    <input type="date" id="filtro-fecha" onchange="cargarCitasAdmin()">
                </div>
            </div>
            <div id="admin-contenido">
                <table class="tabla-citas">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Servicio</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-citas-body">
                        <tr><td colspan="7" style="text-align:center;">Cargando citas...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:8000';
        let servicioSeleccionado = null;
        let todosServicios = [];

        // ========== CAMBIAR TABS ==========
        function cambiarTab(tab) {
            if (tab === 'reservas') {
                document.getElementById('seccion-reservas').classList.remove('oculto');
                document.getElementById('seccion-admin').classList.add('oculto');
                document.getElementById('tab-reservas').classList.add('activo');
                document.getElementById('tab-admin').classList.remove('activo');
                cargarServicios();
            } else {
                document.getElementById('seccion-reservas').classList.add('oculto');
                document.getElementById('seccion-admin').classList.remove('oculto');
                document.getElementById('tab-reservas').classList.remove('activo');
                document.getElementById('tab-admin').classList.add('activo');
                cargarCitasAdmin();
            }
        }

        // ========== SERVICIOS ==========
        async function cargarServicios() {
            try {
                const response = await fetch(`${API_URL}/servicios`);
                todosServicios = await response.json();
                
                const container = document.getElementById('servicios-container');
                container.innerHTML = '';
                
                todosServicios.forEach(servicio => {
                    const card = document.createElement('div');
                    card.className = 'servicio-card';
                    card.onclick = () => seleccionarServicio(servicio, card);
                    card.innerHTML = `
                        <div class="servicio-nombre">${servicio.nombre}</div>
                        <div class="servicio-precio">$${servicio.precio.toLocaleString('es-CO')}</div>
                        <div style="color:#999;">⏱️ ${servicio.duracion} min</div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ========== SELECCIONAR SERVICIO ==========
        function seleccionarServicio(servicio, card) {
            document.querySelectorAll('.servicio-card').forEach(c => c.classList.remove('seleccionado'));
            card.classList.add('seleccionado');
            servicioSeleccionado = servicio;
            
            document.getElementById('formulario').style.display = 'block';
            
            const fechaInput = document.getElementById('fecha');
            const hoy = new Date().toISOString().split('T')[0];
            fechaInput.min = hoy;
            fechaInput.value = hoy;
            
            cargarHorariosDisponibles();
            document.getElementById('formulario').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== HORARIOS DISPONIBLES ==========
        async function cargarHorariosDisponibles() {
            const fecha = document.getElementById('fecha').value;
            if (!fecha) return;
            
            try {
                const response = await fetch(`${API_URL}/disponibilidad?fecha=${fecha}`);
                const data = await response.json();
                
                const selectHora = document.getElementById('hora');
                selectHora.innerHTML = '<option value="">Selecciona una hora</option>';
                
                if (data.disponibles.length === 0) {
                    selectHora.innerHTML += '<option value="" disabled>❌ No hay horarios disponibles</option>';
                } else {
                    data.disponibles.forEach(hora => {
                        const option = document.createElement('option');
                        option.value = hora;
                        option.textContent = hora;
                        selectHora.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error cargando horarios:', error);
            }
        }

        // ========== CREAR RESERVA ==========
        async function crearReserva() {
            if (!servicioSeleccionado) {
                mostrarNotificacion('❌ Error', 'Selecciona un servicio', 'error');
                return;
            }

            const reserva = {
                servicio_id: servicioSeleccionado.id,
                fecha: document.getElementById('fecha').value,
                hora: document.getElementById('hora').value,
                nombre: document.getElementById('nombre').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                email: document.getElementById('email').value.trim(),
                notas: ''
            };

            if (!reserva.fecha || !reserva.hora || !reserva.nombre || !reserva.telefono || !reserva.email) {
                mostrarNotificacion('❌ Error', 'Completa todos los campos', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/citas`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(reserva)
                });

                if (response.ok) {
                    const citaCreada = await response.json();
                    mostrarNotificacion('✅ ¡RESERVA CONFIRMADA!', 
                        `Cita #${citaCreada.id} - ${servicioSeleccionado.nombre}\n${reserva.fecha} ${reserva.hora}`, 'exito');
                    
                    document.getElementById('nombre').value = '';
                    document.getElementById('telefono').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('formulario').style.display = 'none';
                    document.querySelectorAll('.servicio-card').forEach(c => c.classList.remove('seleccionado'));
                    servicioSeleccionado = null;
                }
            } catch (error) {
                mostrarNotificacion('❌ Error', 'Error de conexión', 'error');
            }
        }

        // ========== ADMIN - CARGAR CITAS ==========
        async function cargarCitasAdmin() {
            try {
                const response = await fetch(`${API_URL}/citas`);
                const citas = await response.json();
                
                const serviciosMap = {};
                todosServicios.forEach(s => serviciosMap[s.id] = s.nombre);
                
                const tbody = document.getElementById('tabla-citas-body');
                const filtroEstado = document.getElementById('filtro-estado').value;
                const filtroFecha = document.getElementById('filtro-fecha').value;
                
                let citasFiltradas = [...citas];
                
                if (filtroEstado !== 'todas') {
                    citasFiltradas = citasFiltradas.filter(c => c.estado === filtroEstado);
                }
                if (filtroFecha) {
                    citasFiltradas = citasFiltradas.filter(c => c.fecha === filtroFecha);
                }
                
                if (citasFiltradas.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">No hay citas para mostrar</td></tr>';
                    return;
                }
                
                tbody.innerHTML = citasFiltradas.map(cita => `
                    <tr>
                        <td>#${cita.id}</td>
                        <td>${cita.nombre}<br><small style="color:#999;">${cita.telefono}</small></td>
                        <td>${serviciosMap[cita.servicio_id] || 'Servicio'}</td>
                        <td>${cita.fecha}</td>
                        <td>${cita.hora}</td>
                        <td><span class="estado-${cita.estado}">${cita.estado.toUpperCase()}</span></td>
                        <td>
                            <button class="btn-confirmar" onclick="confirmarCita(${cita.id})" 
                                ${cita.estado === 'confirmada' ? 'disabled' : ''}>
                                ✓ Confirmar
                            </button>
                            <button class="btn-cancelar" onclick="cancelarCita(${cita.id})">
                                🗑️ Cancelar
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error cargando citas:', error);
            }
        }

        // ========== ADMIN - CONFIRMAR CITA ==========
        async function confirmarCita(id) {
            try {
                const response = await fetch(`${API_URL}/citas/${id}/confirmar`, {
                    method: 'PATCH'
                });
                
                if (response.ok) {
                    mostrarNotificacion('✅ Cita confirmada', `La cita #${id} ha sido confirmada`, 'exito');
                    cargarCitasAdmin();
                } else {
                    mostrarNotificacion('❌ Error', 'No se pudo confirmar la cita', 'error');
                }
            } catch (error) {
                mostrarNotificacion('❌ Error', 'Error de conexión', 'error');
            }
        }

        // ========== ADMIN - CANCELAR CITA ==========
        async function cancelarCita(id) {
            if (confirm('¿Estás seguro de cancelar esta cita?')) {
                try {
                    const response = await fetch(`${API_URL}/citas/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        mostrarNotificacion('✅ Cita cancelada', `La cita #${id} ha sido cancelada`, 'info');
                        cargarCitasAdmin();
                    } else {
                        mostrarNotificacion('❌ Error', 'No se pudo cancelar la cita', 'error');
                    }
                } catch (error) {
                    mostrarNotificacion('❌ Error', 'Error de conexión', 'error');
                }
            }
        }

        // ========== NOTIFICACIONES ==========
        function mostrarNotificacion(titulo, contenido, tipo = 'exito') {
            const noti = document.getElementById('notificacion');
            document.getElementById('notificacion-titulo').textContent = titulo;
            document.getElementById('notificacion-contenido').textContent = contenido;
            noti.className = 'notificacion mostrar ' + tipo;
            setTimeout(cerrarNotificacion, 5000);
        }

        function cerrarNotificacion() {
            document.getElementById('notificacion').className = 'notificacion';
        }

        // ========== INICIALIZAR ==========
        cargarServicios();
        document.addEventListener('DOMContentLoaded', () => {
            const fechaInput = document.getElementById('fecha');
            if (fechaInput) {
                fechaInput.min = new Date().toISOString().split('T')[0];
            }
        });
    </script>
</body>
</html>